\subsection{Useful general-purpose kernel APIs}

\begin{frame}
  \frametitle{Memory/string utilities}
  \begin{itemize}
  \item In \kfile{include/linux/string.h}
    \begin{itemize}
    \item Memory-related: \kfunc{memset}, \kfunc{memcpy},
      \kfunc{memmove}, \kfunc{memscan}, \kfunc{memcmp}, \kfunc{memchr}
    \item String-related: \kfunc{strcpy}, \kfunc{strcat}, \kfunc{strcmp},
      \kfunc{strchr}, \kfunc{strrchr}, \kfunc{strlen} and variants
    \item Allocate and copy a string: \kfunc{kstrdup}, \kfunc{kstrndup}
    \item Allocate and copy a memory area: \kfunc{kmemdup}
    \end{itemize}
  \item In \kfile{include/linux/kernel.h}
    \begin{itemize}
    \item String to int conversion: \kfunc{simple_strtoul},
      \kfunc{simple_strtol}, \kfunc{simple_strtoull},
      \kfunc{simple_strtoll}
    \item Other string functions: \kfunc{sprintf}, \kfunc{sscanf}
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Linked lists}
  \begin{itemize}
  \item Convenient linked-list facility in \kfile{include/linux/list.h}
    \begin{itemize}
    \item Used in thousands of places in the kernel
    \end{itemize}
  \item Add a \kstruct{list_head} member to the structure whose
    instances will be part of the linked list. It is usually named
    \code{node} when each instance needs to only be part of a single
    list.
  \item Define the list with the \kfunc{LIST_HEAD} macro for a global
    list, or define a \kstruct{list_head} element and initialize
    it with \kfunc{INIT_LIST_HEAD} for lists embedded in a structure.
  \item Then use the \code{list_*()} API to manipulate the list
    \begin{itemize}
    \item Add elements: \kfunc{list_add}, \kfunc{list_add_tail}
    \item Remove, move or replace elements: \kfunc{list_del},
      \kfunc{list_move}, \kfunc{list_move_tail},
      \kfunc{list_replace}
    \item Test the list: \kfunc{list_empty}
    \item Iterate over the list: \code{list_for_each_*()} family of macros
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Linked lists examples 1/2}
\begin{block}{\kfile{drivers/i2c/busses/i2c-stm32f7.c}}
\begin{minted}[fontsize=\scriptsize]{c}
/**
 * struct stm32f7_i2c_timings - private I2C output parameters
 * @node: List entry
 * @presc: Prescaler value
 * @scldel: Data setup time
 * @sdadel: Data hold time
 * @sclh: SCL high period (master mode)
 * @scll: SCL low period (master mode)
 */
struct stm32f7_i2c_timings {
  struct list_head node;
  u8 presc;
  u8 scldel;
  u8 sdadel;
  u8 sclh;
  u8 scll;
};
\end{minted}
\end{block}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Linked lists examples 2/2}

\begin{block}{\kfile{drivers/i2c/busses/i2c-stm32f7.c}}
\begin{minted}[fontsize=\scriptsize]{c}
static int stm32f7_i2c_compute_timing(/* ... */)
{
  struct stm32f7_i2c_timings *v;
  struct list_head solutions;
  INIT_LIST_HEAD(&solutions);
  /* ... */

  for (p = 0; p < STM32F7_PRESC_MAX; p++) {
    for (l = 0; l < STM32F7_SCLDEL_MAX; l++) {
      v = kmalloc(sizeof(*v), GFP_KERNEL);
      v->presc = p;
      v->scldel = l;
      list_add_tail(&v->node, &solutions);
    }
  }

  list_for_each_entry(v, &solutions, node) {
    /* ... */
  }
}
\end{minted}
\end{block}
\end{frame}
